name: CI

on:
  push: { branches: [ "main" ] }
  pull_request: { branches: [ "main" ] }

jobs:
  checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: pip-${{ runner.os }}-

      - name: Install project + dev dependencies (pinned for typecheck)
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]" -c ci-constraints.txt

      - name: Ruff (lint)
        run: ruff check $(git ls-files '*.py')

      - name: Black (format check)
        run: black --check $(git ls-files '*.py')

      - name: MyPy (type check)
        run: mypy

      - name: Pytest (unit tests)
        run: python -m pytest -q tests

      - name: shfmt (shell script format check)
        run: |
          sudo apt-get install -y shfmt
          shfmt -l -w $(git ls-files '*.sh' '*.bats')
      
      - name: ShellCheck (lint bash)
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: ./aws/scripts
          check_together: 'yes'
          severity: error
        env:
          SHELLCHECK_OPTS: -e SC1091
        
      - name: Setup Bats and libs
        id: setup-bats
        uses: bats-core/bats-action@3.0.1

      - name: Bats (bash tests)
        shell: bash
        env:
          BATS_LIB_PATH: ${{ steps.setup-bats.outputs.lib-path }}
          BATS_SHELL: /usr/bin/bash
        run: |
          shopt -s nullglob globstar
          files=(tests/bash/*.bats tests/bash/**/*.bats)
          if (( ${#files[@]} == 0 )); then
            echo "No Bats tests found; skipping."
          else
            bats -r tests/bash
          fi